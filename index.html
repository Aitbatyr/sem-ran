<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Seminar Randomizer</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --ring: #38bdf8;
      --ok: #dcfce7;
      --over: #f1f5f9;
      --prio: #fef3c7;
      --good: #16a34a;
      --bad: #dc2626;
      --abs: #475569;
      --hl: #2563eb; /* мягкий акцент для Sem / Ran */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",sans-serif; color: var(--text); }
    body { background: var(--bg); display: grid; place-items: start center; padding: 16px; }
    .wrap { width: min(1160px, 100%); display: grid; gap: 16px; }
    h1 { text-align: center; font-size: 22px; margin: 6px 0 0; }
    .hl { color: var(--hl); filter: saturate(.85); }
    .row { display: flex; gap: 10px; justify-content: center; align-items: center; }
    .toolbar { justify-content: space-between; flex-wrap: wrap; }
    .input, .num, .sel {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      outline: none;
      font-size: 15px;
      box-shadow: 0 1px 2px rgb(0 0 0 / 4%);
    }
    .sel { padding-right: 30px; }
    .num { width: 90px; text-align: right; }
    .input:focus, .num:focus, .sel:focus { border-color: var(--ring); box-shadow: 0 0 0 3px rgb(56 189 248 / 25%); }
    .btn {
      border: 1px solid var(--border);
      background: var(--card);
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 1px 2px rgb(0 0 0 / 4%);
      font-size: 15px;
      line-height: 1;
    }
    .btn:active { transform: translateY(1px); }
    .btn.small{ padding: 8px 10px; font-size: 13px; }
    .btn.primary{ border-color: #0ea5e9; box-shadow: 0 0 0 2px rgb(14 165 233 / 15%); }
    .btn.danger{ border-color: #ef4444; }
    .card { border: 1px solid var(--border); background: var(--card); border-radius: 14px; box-shadow: 0 1px 2px rgb(0 0 0 / 4%); }
    .card h2 { margin: 0; font-size: 16px; padding: 12px 14px; border-bottom: 1px solid var(--border); display:flex; justify-content: space-between; align-items: center; gap:8px;}
    .section { display:grid; gap: 8px; padding: 12px; }
    ul { list-style: none; margin: 0; padding: 0; }
    li { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-top: 1px solid var(--border); }
    li:first-child { border-top: 0; }
    .empty { text-align: center; color: var(--muted); padding: 20px; }
    .name { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display:flex; align-items:center; gap:8px; }
    .del { width: 36px; height: 36px; border-radius: 999px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 18px; }
    .del:hover { background: #f8fafc; }
    .hint { text-align: center; color: var(--muted); font-size: 13px; }
    .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .left { display:grid; gap: 12px; }
    .queueControls { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .cap { font-size: 12px; color: var(--muted); min-height: 1em; }
    .ok { background: var(--ok); }
    .over { background: var(--over); color: #334155; }
    .chip { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); color: #334155; background: #fff; }
    .star { font-size: 12px; color: #b45309; background: var(--prio); border: 1px solid #f59e0b; padding: 2px 6px; border-radius: 999px; }
    .stats { display:flex; gap:8px; align-items:center; margin-left: 4px; }
    .good { color: var(--good); font-weight: 600; }
    .bad { color: var(--bad); font-weight: 600; }
    .absCnt { color: var(--abs); font-weight: 600; }
    .abs { color: #94a3b8; text-decoration: line-through; }
    .absToggle { display:flex; align-items:center; gap:6px; font-size: 12px; color:#334155; }
    @media (max-width: 940px){ .cols{ grid-template-columns: 1fr; } }
    .settings { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .settings label { display:flex; align-items:center; gap:6px; color:#334155; font-size:14px; }
    .edit{ padding:6px 8px; font-size:14px; border:1px solid var(--border); border-radius:8px; outline:none; }
    .edit:focus{ border-color: var(--ring); box-shadow: 0 0 0 3px rgb(56 189 248 / 25%);}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="hdrTitle">Seminar Randomizer</h1>

    <div class="row toolbar">
      <div class="row">
        <button id="importBtn" class="btn">Импорт</button>
        <input id="fileInput" type="file" accept=".json,application/json" hidden>
        <button id="exportBtn" class="btn">Экспорт</button>
        <button id="helpBtn" class="btn">Помощь</button>
      </div>
      <div class="queueControls">
        <button id="randomizeBtn" class="btn primary">Randomize</button>
        <button id="shareBtn" class="btn">Поделиться</button>
        <button id="endBtn" class="btn danger">Завершить пару</button>
        <button id="clearQueueBtn" class="btn">Сбросить очередь</button>
        <button id="resetStatsBtn" class="btn danger">Сбросить статистику</button>
        <select id="langSel" class="sel" title="">
          <option value="ru">Рус</option>
          <option value="en">Eng</option>
          <option value="kk">Қаз</option>
        </select>
      </div>
    </div>

    <div class="card">
      <h2><span id="timeSettingsTitle">Настройки времени</span> <span class="cap" id="capInfo"></span></h2>
      <div class="section settings">
        <label id="lblPair"><span>Длительность пары (мин):</span> <input id="pairMin" class="num" type="number" min="10" step="5" value="100"></label>
        <label id="lblPer"><span>Минут на одного:</span> <input id="perMin" class="num" type="number" min="1" step="1" value="3"></label>
        <span class="chip" id="calcNote"></span>
        <label><input type="checkbox" id="autoExport"> <span id="lblAutoExport">Автоэкспорт при завершении</span></label>
      </div>
    </div>

    <div class="cols">
      <div class="left">
        <div class="card">
          <h2><span id="studentsTitle">Студенты</span>
            <span id="countBadge" class="cap"></span> 
            <span id="prioBadge" class="cap"></span>
            <span id="absBadge" class="cap"></span>
          </h2>
          <div class="section row" style="justify-content: space-between; gap: 8px;">
            <div class="row" style="flex:1;">
              <input id="input" class="input" placeholder="добавить студента" autocomplete="off" />
              <button id="addBtn" class="btn" title="Добавить" aria-label="Добавить">+</button>
            </div>
            <label class="absToggle"><input type="checkbox" id="toggleAbsMode"> <span id="absModeText">режим отметки отсутствия</span></label>
          </div>
          <div class="hint" id="hintStats">...</div>
          <ul id="list">
            <li class="empty" id="emptyList">Пока пусто</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <h2><span id="queueTitle">Очередь на сегодня</span> <span id="queueCap" class="cap"></span></h2>
        <div class="section">
          <ul id="queue">
            <li class="empty" id="emptyQueue">Нажмите Randomize</li>
          </ul>
          <div class="hint" id="hintQueueAbs">Отсутствующие НЕ попадают в очередь и им не начисляется ✗.</div>
        </div>
      </div>
    </div>

    <div id="helpOverlay" class="helpOverlay" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); align-items:center; justify-content:center; padding:16px; z-index:1000;">
      <div class="card" style="width:min(900px,100%); max-height:80vh; overflow:auto;">
        <h2 id="helpTitle">Справка по системе</h2>
        <div class="section" style="gap:10px;">
          <div id="helpIntro"></div>
          <ul id="helpList" style="margin-left:16px;"></ul>
          <div id="helpLegend" class="hint"></div>
          <div id="helpStorage" class="hint"></div>
          <div id="helpContact" class="hint"></div>
          <div class="row" style="justify-content:flex-end; gap:8px;">
            <button id="helpClose" class="btn">Понятно</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // ===== i18n =====
      const LANG_KEY = "sr_lang";
      const i18n = {
        ru: {
          app_title: "Seminar Randomizer",
          import: "Импорт",
          export: "Экспорт",
          help: "Помощь",
          randomize: "Randomize",
          share: "Поделиться",
          share_copied: "Ссылка скопирована. Это снимок текущей очереди. Если очередь изменится — сгенерируй ссылку заново.",
          end: "Завершить пару",
          clear_queue: "Сбросить очередь",
          reset_stats: "Сбросить статистику",
          end_done: "Пара завершена.",
          lang_title: "Язык",
          time_settings: "Настройки времени",
          limit: "Лимит: {n}",
          pair_label: "Длительность пары (мин):",
          per_label: "Минут на одного:",
          calc_note: "Расчёт: floor(длительность / на одного)",
          auto_export: "Автоэкспорт при завершении",
          students: "Студенты",
          add_placeholder: "добавить студента",
          add: "Добавить",
          abs_mode: "режим отметки отсутствия",
          hint_stats: "В режиме отметки кликай по имени, чтобы пометить как отсутствующего (сегодня). Статистика: <span class=\"good\">✓ — выступил</span>, <span class=\"bad\">✗ — не успел</span>, <span class=\"absCnt\">Ø — отсутствовал</span>. Двойной клик по имени — переименовать.",
          empty_list: "Пока пусто",
          queue_today: "Очередь на сегодня",
          empty_queue: "Нажмите Randomize",
          hint_queue_abs: "Отсутствующие НЕ попадают в очередь и им не начисляется ✗.",
          prio_badge: "приоритет: {n}",
          abs_badge: "отмечены отсутствующие: {n}",
          count_badge: "({n})",
          queue_will_fit: "Успеют ≈ {a} из {b}",
          help_title: "Справка по системе",
          help_intro: "Для порядка на семинаре: очередь, приоритеты, отсутствие, автоматический учёт.",
          help_items: [
            "<b>Добавить студента</b> — поле «добавить студента» + «+». Удаление — кнопка «–» напротив имени.",
            "<b>Переименовать</b> — двойной клик по имени (Enter — сохранить, Esc — отменить).",
            "<b>Режим отметки отсутствия</b> — включите чекбокс и кликните по имени. Отсутствующие не попадают в очередь и им не начисляется ✗. Ø растёт при «Завершить пару».",
            "<b>Randomize</b> — формирует очередь: сначала <i>приоритетные</i>, затем остальные случайно.",
            "<b>Очередь</b>: «<i>Выступил ✓</i>» — снимает приоритет и +1 к ✓; «<i>Пропустить →</i>» — переносит в конец.",
            "<b>Настройки времени</b> — «Длительность пары» и «Минут на одного» считают лимит (сколько человек успеет).",
            "<b>Поделиться</b> — создаёт ссылку‑снимок текущей очереди (viewer.html).",
            "<b>Завершить пару</b> — тем, кто остался в очереди и присутствовал: +1 ✗ и приоритет; отмеченным как отсутствующие — +1 Ø; очередь/отметки очищаются.",
            "<b>Сбросить статистику</b> — обнуляет ✓/✗/Ø, снимает приоритеты, очищает очередь и отметки отсутствия (нужно ввести «подтвердить»).",
            "<b>Импорт/Экспорт</b> — перенос данных между устройствами. Экспорт сохраняет всех студентов, очередь, настройки, отметки и язык."
          ],
          help_legend: "Легенда: <span class=\"good\">✓ — выступил</span>, <span class=\"bad\">✗ — не успел</span>, <span class=\"absCnt\">Ø — отсутствовал</span>, <span class=\"star\" style=\"padding:2px 6px;\">приоритет</span>.",
          help_storage: "Данные хранятся в этом браузере (localStorage). Для переноса — Экспорт → Импорт на другом ПК.",
          help_contact: "Если заметили неисправности в работе сайте или есть предложения по поводу улучшения сайте то напиши об этом на почту <b>aitbatyr.i@gmail.com</b>.",
          help_close: "Понятно",
          rename_hint: "Двойной клик по имени — переименовать. Enter — сохранить, Esc — отменить.",
          reset_confirm: "Полный сброс у ВСЕХ: статистика (✓/✗/Ø) → 0, приоритеты сняты, очередь и отметки отсутствия очищены.\nСписок и настройки времени не меняются.\n\nДля подтверждения введите слово: подтвердить",
          reset_done: "Сброс выполнен.",
          cancelled: "Отменено.",
          need_students: "Сначала добавьте студентов.",
          no_present: "Никого из присутствующих нет.",
          performed: "Выступил ✓",
          skip: "Пропустить →",
          delete_word: "Удалить",
          bad_json: "Неверный формат JSON.",
          read_fail: "Не удалось прочитать JSON."
        },
        en: {
          app_title: "Seminar Randomizer",
          import: "Import",
          export: "Export",
          help: "Help",
          randomize: "Randomize",
          share: "Share",
          share_copied: "Link copied. This is a snapshot of the current queue. If it changes, generate a new link.",
          end: "End session",
          clear_queue: "Clear queue",
          reset_stats: "Reset stats",
          end_done: "Session finalized.",
          lang_title: "Language",
          time_settings: "Time settings",
          limit: "Limit: {n}",
          pair_label: "Session length (min):",
          per_label: "Minutes per student:",
          calc_note: "Calc: floor(length / per student)",
          auto_export: "Auto‑export on end",
          students: "Students",
          add_placeholder: "add a student",
          add: "Add",
          abs_mode: "absence marking mode",
          hint_stats: "With absence mode on, click a name to mark absent (today). Stats: <span class=\"good\">✓ — spoke</span>, <span class=\"bad\">✗ — missed</span>, <span class=\"absCnt\">Ø — absent</span>. Double‑click a name to rename.",
          empty_list: "Empty",
          queue_today: "Queue for today",
          empty_queue: "Press Randomize",
          hint_queue_abs: "Absentees don't go into the queue and don't get ✗.",
          prio_badge: "priority: {n}",
          abs_badge: "marked absent: {n}",
          count_badge: "({n})",
          queue_will_fit: "About {a} of {b} will fit",
          help_title: "How it works",
          help_intro: "Keep order in seminars: queue, priorities, absence, and automatic tracking.",
          help_items: [
            "<b>Add a student</b> — type the name and press «+». Remove via the «–» button.",
            "<b>Rename</b> — double‑click a name (Enter to save, Esc to cancel).",
            "<b>Absence mode</b> — enable the checkbox and click a name. Absentees are excluded from the queue and don't receive ✗. Ø increases on «End session».",
            "<b>Randomize</b> — builds the queue: first <i>priority</i>, then others randomly.",
            "<b>Queue</b>: «<i>Spoke ✓</i>» clears priority and adds ✓; «<i>Skip →</i>» sends to the end.",
            "<b>Time settings</b> — length and per-student minutes compute the limit.",
            "<b>Share</b> — creates a snapshot link to viewer.html.",
            "<b>End session</b> — remaining present get ✗ and priority; marked absentees get Ø; queue & absence marks are cleared.",
            "<b>Reset stats</b> — zeroes ✓/✗/Ø, clears priorities, queue and absence marks (type «подтвердить»).",
            "<b>Import/Export</b> — move data across devices. Export saves students, queue, settings, marks, and language."
          ],
          help_legend: "Legend: <span class=\"good\">✓ — spoke</span>, <span class=\"bad\">✗ — missed</span>, <span class=\"absCnt\">Ø — absent</span>, <span class=\"star\" style=\"padding:2px 6px;\">priority</span>.",
          help_storage: "Data lives in this browser (localStorage). Use Export/Import to transfer.",
          help_contact: "If you notice issues or have ideas, email <b>aitbatyr.i@gmail.com</b>.",
          help_close: "Got it",
          rename_hint: "Double‑click a name to rename. Enter to save, Esc to cancel.",
          reset_confirm: "Full reset for ALL: stats (✓/✗/Ø) → 0, priorities cleared, queue and absence marks cleared.\nGroup list and time settings are kept.\n\nType: подтвердить",
          reset_done: "Reset done.",
          cancelled: "Cancelled.",
          need_students: "Add students first.",
          no_present: "No present students.",
          performed: "Spoke ✓",
          skip: "Skip →",
          delete_word: "Delete",
          bad_json: "Invalid JSON.",
          read_fail: "Failed to read JSON."
        },
        kk: {
          app_title: "Seminar Randomizer",
          import: "Импорттау",
          export: "Экспорт",
          help: "Көмек",
          randomize: "Кездейсоқ рет",
          share: "Бөлісу",
          share_copied: "Сілтеме көшірілді. Бұл ағымдағы кезектің суреті. Өзгерсе — жаңа сілтеме жаса.",
          end: "Сабақты аяқтау",
          clear_queue: "Кезекті тазарту",
          reset_stats: "Статистиканы тазарту",
          end_done: "Сабақ аяқталды.",
          lang_title: "Тіл",
          time_settings: "Уақыт баптауы",
          limit: "Лимит: {n}",
          pair_label: "Пара ұзақтығы (мин):",
          per_label: "Бір адамға минут:",
          calc_note: "Есеп: floor(ұзақтық / адам)",
          auto_export: "Соңында автоэкспорт",
          students: "Студенттер",
          add_placeholder: "студент қосу",
          add: "Қосу",
          abs_mode: "қатыспау белгілеу режимі",
          hint_stats: "Қатыспау режимінде атты басып — бүгін қатыспады деп белгілеңіз. Статистика: <span class=\"good\">✓ — сөйледі</span>, <span class=\"bad\">✗ — үлгермеді</span>, <span class=\"absCnt\">Ø — болмады</span>. Атын өзгерту үшін — екі рет басыңыз.",
          empty_list: "Әзірге бос",
          queue_today: "Бүгінгі кезек",
          empty_queue: "Кездейсоқ рет басыңыз",
          hint_queue_abs: "Қатыспағандар кезекке кірмейді және ✗ қойылмайды.",
          prio_badge: "приоритет: {n}",
          abs_badge: "қатыспаған: {n}",
          count_badge: "({n})",
          queue_will_fit: "Шамамен {a}/{b} үлгереді",
          help_title: "Жүйе туралы",
          help_intro: "Семинарда тәртіп: кезек, приоритет, қатыспау және автоматты есеп.",
          help_items: [
            "<b>Студент қосу</b> — атты жазып «+». Жою — жанындағы «–».",
            "<b>Атын өзгерту</b> — атына екі рет басыңыз (Enter — сақтау, Esc — болдырмау).",
            "<b>Қатыспау режимі</b> — құсбелгіні қосып, атты басыңыз. Қатыспағандар кезекке кірмейді, ✗ қойылмайды. Ø «Сабақты аяқтау» кезінде өседі.",
            "<b>Кездейсоқ рет</b> — кезек құрылады: алдымен <i>приоритет</i>, кейін қалғандар.",
            "<b>Кезек</b>: «<i>Сөйледі ✓</i>» — приоритетті алып тастайды және ✓ қосады; «<i>Өткізу →</i>» — соңына жібереді.",
            "<b>Уақыт баптауы</b> — ұзақтық пен бір адамға минут лимитті есептейді.",
            "<b>Бөлісу</b> — viewer.html бетіне сілтеме-сурет жасайды.",
            "<b>Сабақты аяқтау</b> — кезекте қалған қатысқандарға ✗ және приоритет; белгіленген қатыспағандарға Ø; кезек және белгілер тазарады.",
            "<b>Статистиканы тазарту</b> — ✓/✗/Ø нөлге; приоритеттер, кезек және белгілер тазаланады («подтвердить» жазыңыз).",
            "<b>Импорт/Экспорт</b> — құрылғылар арасында дерек көшіру. Экспорт студенттерді, кезекті, баптауларды, белгілер мен тілді сақтайды."
          ],
          help_legend: "Белгілер: <span class=\"good\">✓ — сөйледі</span>, <span class=\"bad\">✗ — үлгермеді</span>, <span class=\"absCnt\">Ø — болмады</span>.",
          help_storage: "Дерек осы браузерде сақталады (localStorage). Көшіру үшін — Экспорт/Импорт.",
          help_contact: "Егер ақаулар байқасаңыз немесе ұсыныстарыңыз болса, осы адреске жазыңыз: <b>aitbatyr.i@gmail.com</b>.",
          help_close: "Түсіндім",
          rename_hint: "Атын өзгерту үшін — екі рет басыңыз. Enter — сақтау, Esc — болдырмау.",
          reset_confirm: "Толық тазарту (бәріне): статистика (✓/✗/Ø) → 0, приоритеттер өшіріледі, кезек пен қатыспау белгілері тазарады.\nТізім және уақыт баптауы сақталады.\n\nЖазыңыз: подтвердить",
          reset_done: "Тазарту орындалды.",
          cancelled: "Болдырылмады.",
          need_students: "Алдымен студенттерді қосыңыз.",
          no_present: "Қатысушылар жоқ.",
          performed: "Сөйледі ✓",
          skip: "Өткізу →",
          delete_word: "Жою",
          bad_json: "JSON дұрыс емес.",
          read_fail: "JSON оқу мүмкін болмады."
        }
      };

      function getLang(){ return localStorage.getItem(LANG_KEY) || "ru"; }
      function setLang(l){ localStorage.setItem(LANG_KEY, l); document.documentElement.lang = l; }

      function t(key, params){
        const l = getLang();
        const pack = i18n[l] || i18n.ru;
        let s = (pack[key] !== undefined ? pack[key] : (i18n.ru[key] || key));
        if (params) for (const k in params){ s = s.replaceAll(`{${k}}`, params[k]); }
        return s;
      }
      function locale(){
        const l = getLang();
        if (l === "ru") return "ru-RU";
        if (l === "kk") return "kk-KZ";
        return "en-US";
      }

      // ===== Storage keys =====
      const KEY = "sr_step1_students";
      const QKEY = "sr_step2_queue";
      const SKEY = "sr_step3_settings";
      const AKEY = "sr_step6_absent_today";
      const PKEY = "sr_pending_finalize";

      // ===== DOM =====
      const $hdrTitle = document.getElementById("hdrTitle");
      const $importBtn = document.getElementById("importBtn");
      const $exportBtn = document.getElementById("exportBtn");
      const $helpBtn = document.getElementById("helpBtn");
      const $langSel = document.getElementById("langSel");

      const $randomize = document.getElementById("randomizeBtn");
      const $shareBtn = document.getElementById("shareBtn");
      const $endBtn = document.getElementById("endBtn");
      const $clearQueue = document.getElementById("clearQueueBtn");
      const $resetStats = document.getElementById("resetStatsBtn");

      const $timeSettingsTitle = document.getElementById("timeSettingsTitle");
      const $capInfo = document.getElementById("capInfo");
      const $lblPair = document.getElementById("lblPair");
      const $lblPer = document.getElementById("lblPer");
      const $calcNote = document.getElementById("calcNote");
      const $pairMin = document.getElementById("pairMin");
      const $perMin = document.getElementById("perMin");
      const $autoExport = document.getElementById("autoExport");
      const $lblAutoExport = document.getElementById("lblAutoExport");

      const $studentsTitle = document.getElementById("studentsTitle");
      const $input = document.getElementById("input");
      const $add = document.getElementById("addBtn");
      const $toggleAbsMode = document.getElementById("toggleAbsMode");
      const $absModeText = document.getElementById("absModeText");
      const $hintStats = document.getElementById("hintStats");
      const $list = document.getElementById("list");
      const $emptyList = document.getElementById("emptyList");

      const $queueTitle = document.getElementById("queueTitle");
      const $queue = document.getElementById("queue");
      const $emptyQueue = document.getElementById("emptyQueue");
      const $queueCap = document.getElementById("queueCap");

      const $count = document.getElementById("countBadge");
      const $prioBadge = document.getElementById("prioBadge");
      const $absBadge = document.getElementById("absBadge");

      // ===== Utils =====
      function uid(){ return (self.crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).slice(2)); }
      function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
      function nowISO(){ return new Date().toISOString(); }

      // ===== Title highlight =====
      function decorateTitle(s){
        const parts = (s||"").split(" ");
        if (parts.length >= 2){
          const a = parts[0], b = parts.slice(1).join(" ");
          return `<span class="hl">${a.slice(0,3)}</span>${a.slice(3)} <span class="hl">${b.slice(0,3)}</span>${b.slice(3)}`;
        }
        return s;
      }

      function renderHelpTexts(){
        document.getElementById("helpTitle").textContent = t("help_title");
        document.getElementById("helpIntro").textContent = t("help_intro");
        const $helpList = document.getElementById("helpList");
        $helpList.innerHTML = "";
        const items = (i18n[getLang()] && i18n[getLang()].help_items) || i18n.ru.help_items;
        items.forEach(html => {
          const li = document.createElement("li"); li.innerHTML = html; $helpList.appendChild(li);
        });
        document.getElementById("helpLegend").innerHTML = t("help_legend");
        document.getElementById("helpStorage").innerHTML = t("help_storage");
        document.getElementById("helpContact").innerHTML = t("help_contact");
      }

      // ===== Storage helpers =====
      function ensureStudent(x){
        if (typeof x === "string") return { id: uid(), name: x, carry: false, spoke: 0, missed: 0, absences: 0 };
        return { 
          id: x.id || uid(), 
          name: (x.name || "").trim(), 
          carry: !!x.carry,
          spoke: Number.isFinite(+x.spoke) ? +x.spoke : 0,
          missed: Number.isFinite(+x.missed) ? +x.missed : 0,
          absences: Number.isFinite(+x.absences) ? +x.absences : 0,
        };
      }
      function load(){ try{ const raw = localStorage.getItem(KEY); const arr = raw ? JSON.parse(raw) : []; return arr.map(ensureStudent);}catch(e){ return []; } }
      function save(arr){ try{ localStorage.setItem(KEY, JSON.stringify(arr)); }catch(e){} }
      function loadQ(){ try{ const raw = localStorage.getItem(QKEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
      function saveQ(arr){ try{ localStorage.setItem(QKEY, JSON.stringify(arr)); }catch(e){} }
      function loadS(){ try{ const raw = localStorage.getItem(SKEY); if (!raw) return { pair: 100, per: 3, autoExport: false }; const o = JSON.parse(raw); return { pair: Number(o.pair)||100, per: Math.max(1, Number(o.per)||3), autoExport: !!o.autoExport }; } catch { return { pair: 100, per: 3, autoExport: false }; } }
      function saveS(o){ try{ localStorage.setItem(SKEY, JSON.stringify(o)); } catch {} }
      function loadA(){ try{ const raw = localStorage.getItem(AKEY); const arr = raw ? JSON.parse(raw) : []; return new Set(Array.isArray(arr)?arr:[]);}catch(e){ return new Set(); } }
      function saveA(set){ try{ localStorage.setItem(AKEY, JSON.stringify(Array.from(set))); }catch(e){} }

      // ===== State =====
      let students = load();
      let queue = loadQ();
      let absentToday = loadA();

      // ===== UI helpers =====
      function capacity(){ 
        const pair = Math.max(1, Number($pairMin.value) || 100);
        const per = Math.max(1, Number($perMin.value) || 3);
        return Math.floor(pair / per);
      }
      function updateCaps(){
        const cap = capacity();
        $capInfo.textContent = t("limit", { n: cap });
        $queueCap.textContent = queue.length ? t("queue_will_fit", { a: Math.min(cap, queue.length), b: queue.length }) : "";
      }
      function statsEl(s){
        const box = document.createElement("span");
        box.className = "stats";
        const g = document.createElement("span"); g.className = "good"; g.textContent = `✓ ${s.spoke}`;
        const b = document.createElement("span"); b.className = "bad"; b.textContent = `✗ ${s.missed}`;
        const a = document.createElement("span"); a.className = "absCnt"; a.textContent = `Ø ${s.absences}`;
        box.appendChild(g); box.appendChild(b); box.appendChild(a);
        return box;
      }
      function updateBadges(){
        $count.textContent = students.length ? t("count_badge", { n: students.length }) : "";
        const prioCount = students.filter(s => s.carry).length;
        $prioBadge.textContent = prioCount ? t("prio_badge", { n: prioCount }) : "";
        const absCount = Array.from(absentToday).length;
        $absBadge.textContent = absCount ? t("abs_badge", { n: absCount }) : "";
      }

      function render(items){
        $list.innerHTML = "";
        updateBadges();
        const renameHint = t('rename_hint');
        if(!items.length){
          const li = document.createElement("li");
          li.className = "empty";
          li.textContent = t("empty_list");
          $list.appendChild(li);
          return;
        }
        for(const s of items){
          const li = document.createElement("li");

          const leftWrap = document.createElement("div");
          leftWrap.className = "name";
          if (absentToday.has(s.id)) leftWrap.classList.add("abs");

          const nameSpan = document.createElement("span");
          nameSpan.textContent = s.name;
          nameSpan.title = renameHint;
          nameSpan.style.cursor = "text";
          nameSpan.addEventListener("dblclick", (ev) => {
            ev.stopPropagation();
            if ($toggleAbsMode.checked) return;
            const input = document.createElement("input");
            input.type = "text";
            input.className = "edit";
            input.value = s.name;
            nameSpan.replaceWith(input);
            input.focus();
            input.select();
            const cancel = () => { try { input.replaceWith(nameSpan); } catch {} };
            const commit = () => {
              const v = (input.value || "").trim();
              if (v && v !== s.name) {
                const target = students.find(x => x.id === s.id);
                if (target) { target.name = v; save(students); }
                render(students);
                renderQueue();
                return;
              }
              cancel();
            };
            input.addEventListener("keydown", (e)=>{
              if (e.key === "Enter") commit();
              else if (e.key === "Escape") cancel();
            });
            input.addEventListener("blur", commit);
          });
          leftWrap.appendChild(nameSpan);

          if (s.carry) {
            const tag = document.createElement("span");
            tag.className = "star";
            tag.textContent = "приоритет";
            leftWrap.appendChild(tag);
          }
          leftWrap.appendChild(statsEl(s));

          leftWrap.addEventListener("click", (ev) => {
            if (ev && ev.detail && ev.detail > 1) return;
            if (ev && (ev.target && ev.target.tagName === 'INPUT')) return;
            if (!$toggleAbsMode.checked) return;
            if (absentToday.has(s.id)) absentToday.delete(s.id); else absentToday.add(s.id);
            saveA(absentToday);
            if (absentToday.has(s.id)) {
              queue = queue.filter(x => x !== s.id);
              saveQ(queue);
              renderQueue();
            }
            render(students);
          });

          const btn = document.createElement("button");
          btn.className = "del";
          btn.textContent = "–";
          btn.title = t("delete_word");
          btn.setAttribute("aria-label", t("delete_word"));
          btn.addEventListener("click", () => {
            students = students.filter(x => x.id !== s.id);
            save(students);
            if (absentToday.has(s.id)) { absentToday.delete(s.id); saveA(absentToday); }
            queue = queue.filter(id => id !== s.id);
            saveQ(queue);
            render(students);
            renderQueue();
          });

          li.appendChild(leftWrap);
          li.appendChild(btn);
          $list.appendChild(li);
        }
      }

      function renderQueue(){
        $queue.innerHTML = "";
        const cap = capacity();
        if(!queue.length){
          const li = document.createElement("li");
          li.className = "empty";
          li.textContent = t("empty_queue");
          $queue.appendChild(li);
          updateCaps();
          return;
        }
        queue.forEach((id, idx) => {
          const s = students.find(x => x.id === id);
          if(!s) return;
          const li = document.createElement("li");
          if (idx < cap) li.classList.add("ok"); else li.classList.add("over");

          const left = document.createElement("div");
          left.className = "name";
          if (absentToday.has(s.id)) left.classList.add("abs");
          left.textContent = `${idx+1}. ${s.name}`;
          if (s.carry) {
            const tag = document.createElement("span");
            tag.className = "star";
            tag.textContent = "приоритет";
            left.appendChild(tag);
          }
          left.appendChild(statsEl(s));

          const buttons = document.createElement("div");

          const ok = document.createElement("button");
          ok.className = "btn small";
          ok.textContent = t("performed");
          ok.title = t("performed");
          ok.addEventListener("click", () => {
            queue = queue.filter(x => x !== id);
            const st = students.find(x => x.id === id);
            if (st) { st.spoke = (st.spoke||0) + 1; st.carry = false; }
            save(students);
            saveQ(queue);
            render(students);
            renderQueue();
          });

          const skip = document.createElement("button");
          skip.className = "btn small";
          skip.textContent = t("skip");
          skip.title = t("skip");
          skip.addEventListener("click", () => {
            queue = queue.filter(x => x !== id);
            queue.push(id);
            saveQ(queue);
            renderQueue();
          });

          buttons.appendChild(ok);
          buttons.appendChild(skip);
          li.appendChild(left);
          li.appendChild(buttons);
          $queue.appendChild(li);
        });
        updateCaps();
      }

      // ===== Import / Export / Share =====
      function doExport(){
        const payload = {
          version: 2,
          at: nowISO(),
          lang: getLang(),
          students,
          settings: loadS(),
          queue,
          absent: Array.from(absentToday)
        };
        const data = JSON.stringify(payload, null, 2);
        const blob = new Blob([data], { type: "application/json" });
        const ts = payload.at.replace(/[:]/g, "-");
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `seminar_randomizer_export_${ts}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      }
      function importJSON(file){
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const parsed = JSON.parse(text);
            let items = [];
            let settings = null;
            let q = [];
            let abs = [];
            let lang = null;
            if (Array.isArray(parsed)) {
              items = parsed;
            } else if (parsed && Array.isArray(parsed.students)) {
              items = parsed.students;
              settings = parsed.settings || null;
              q = Array.isArray(parsed.queue) ? parsed.queue : [];
              abs = Array.isArray(parsed.absent) ? parsed.absent : [];
              lang = typeof parsed.lang === "string" ? parsed.lang : null;
            } else {
              alert(t("bad_json"));
              return;
            }
            items = items.map(ensureStudent).filter(x => x.name);
            students = items; save(students);
            if (settings) { saveS(settings); $pairMin.value = settings.pair; $perMin.value = settings.per; if ($autoExport) $autoExport.checked = !!settings.autoExport; }
            queue = q; saveQ(queue);
            absentToday = new Set(abs); saveA(absentToday);
            if (lang) { setLang(lang); }
            render(students);
            renderQueue();
            updateBadges();
            updateStaticTexts();
          } catch (err) {
            console.error(err);
            alert(t("read_fail"));
          }
        };
        reader.readAsText(file, "utf-8");
      }
      function toB64(obj){
        const str = JSON.stringify(obj);
        const bytes = new TextEncoder().encode(str);
        let bin = ""; for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
        return btoa(bin);
      }
      function shareQueue(){
        if (!queue || !queue.length){
          alert(t("empty_queue"));
          return;
        }
        const cap = capacity();
        const payload = {
          at: nowISO(),
          cap,
          queue: queue.map((id, idx) => {
            const s = students.find(x => x.id === id);
            return { pos: idx+1, name: s ? s.name : "—", prio: !!(s && s.carry) };
          })
        };
        const b64 = toB64(payload);
        const url = new URL('viewer.html', location.href).href + '#' + b64;
        try { navigator.clipboard.writeText(url); } catch {}
        alert(t("share_copied") + "\n" + url);
      }

      
      // ===== Queue build =====
      function randomizeQueue(){
        if(!students.length){ alert(t("need_students")); return; }
        const present = students.filter(s => !absentToday.has(s.id));
        if(!present.length){ alert(t("no_present")); return; }
        const prio = shuffle(present.filter(s => s.carry).map(s => s.id));
        const rest = shuffle(present.filter(s => !s.carry).map(s => s.id));
        queue = [...prio, ...rest];
        saveQ(queue);
        renderQueue();
      }
// ===== End session & settings =====
      function endSession(opts){
        const silent = opts && opts.silent;
        const remaining = new Set(queue);
        if (remaining.size) {
          students = students.map(s => {
            if (remaining.has(s.id) && !absentToday.has(s.id)) {
              return { ...s, carry: true, missed: (s.missed||0) + 1 };
            }
            return s;
          });
        }
        if (absentToday.size) {
          students = students.map(s => absentToday.has(s.id) ? { ...s, absences: (s.absences||0) + 1 } : s);
        }
        save(students);
        queue = [];
        saveQ(queue);
        absentToday = new Set();
        saveA(absentToday);
        updateBadges();
        render(students);
        renderQueue();
        updateCaps();
        if (!silent) {
          if ($autoExport && $autoExport.checked) { try{ doExport(); }catch(e){} }
          alert(t("end_done"));
        }
      }

      function onSettingsChange(){
        let pair = Math.max(1, Number($pairMin.value) || 100);
        let per = Math.max(1, Number($perMin.value) || 3);
        const autoExport = !!($autoExport && $autoExport.checked);
        saveS({ pair, per, autoExport });
        renderQueue();
        updateCaps();
      }

      // ===== Pending finalize: only on true exit, not reload =====
      function navType(){
        try {
          const e = performance.getEntriesByType("navigation")[0];
          if (e && e.type) return e.type; // 'navigate' | 'reload' | 'back_forward' | 'prerender'
          if (performance.navigation) {
            if (performance.navigation.type === 1) return "reload";
            if (performance.navigation.type === 2) return "back_forward";
          }
        } catch {}
        return "navigate";
      }
      function needAutoFinalize(){ return (queue && queue.length > 0) || (absentToday && absentToday.size > 0); }
      function savePendingFinalize(){
        try {
          if (!needAutoFinalize()) { localStorage.removeItem(PKEY); return; }
          const payload = { at: nowISO(), queue: Array.from(queue || []), absent: Array.from(absentToday || []) };
          localStorage.setItem(PKEY, JSON.stringify(payload));
        } catch {}
      }
      function applyPendingIfNeeded(){
        const raw = localStorage.getItem(PKEY);
        if (!raw) return;
        const ttype = navType();
        if (ttype === "reload") { localStorage.removeItem(PKEY); return; }
        let p; try { p = JSON.parse(raw); } catch { localStorage.removeItem(PKEY); return; }
        const remaining = new Set(Array.isArray(p.queue) ? p.queue : []);
        const absentSet = new Set(Array.isArray(p.absent) ? p.absent : []);
        if (remaining.size) {
          students = students.map(s => {
            if (remaining.has(s.id) && !absentSet.has(s.id)) {
              return { ...s, carry: true, missed: (s.missed||0) + 1 };
            }
            return s;
          });
        }
        if (absentSet.size) {
          students = students.map(s => absentSet.has(s.id) ? { ...s, absences: (s.absences||0) + 1 } : s);
        }
        save(students);
        queue = [];
        saveQ(queue);
        absentToday = new Set();
        saveA(absentToday);
        localStorage.removeItem(PKEY);
      }
      window.addEventListener("beforeunload", savePendingFinalize);

      // ===== Help open/close =====
      function openHelp(){ document.getElementById("helpOverlay").style.display = "flex"; }
      function closeHelp(){ document.getElementById("helpOverlay").style.display = "none"; }
      document.getElementById("helpBtn").addEventListener("click", openHelp);
      document.getElementById("helpClose").addEventListener("click", closeHelp);
      document.getElementById("helpOverlay").addEventListener("click", (e)=>{ if (e.target.id === "helpOverlay") closeHelp(); });
      document.addEventListener("keydown", (e)=>{
        if (e.key === "Escape") closeHelp();
        if (e.key === '?' || (e.shiftKey && e.key === '/')) openHelp();
      });

      // ===== Bindings =====
      const $file = document.getElementById("fileInput");
      $importBtn.addEventListener("click", () => $file.click());
      $file.addEventListener("change", () => {
        if ($file.files && $file.files[0]) importJSON($file.files[0]);
        $file.value = "";
      });
      $exportBtn.addEventListener("click", doExport);

      $randomize.addEventListener("click", randomizeQueue);
      $shareBtn.addEventListener("click", shareQueue);
      $clearQueue.addEventListener("click", () => { queue = []; saveQ(queue); renderQueue(); });
      $endBtn.addEventListener("click", () => endSession({silent:false}));
      $resetStats.addEventListener("click", () => {
        const phrase = prompt(t("reset_confirm"), "");
        if (phrase !== "подтвердить") { alert(t("cancelled")); return; }
        students = students.map(s => ({ ...s, spoke: 0, missed: 0, absences: 0, carry: false }));
        save(students);
        queue = [];
        saveQ(queue);
        absentToday = new Set();
        saveA(absentToday);
        updateBadges();
        render(students);
        renderQueue();
        updateCaps();
        alert(t("reset_done"));
      });
      ["input","change"].forEach(ev => {
        $pairMin.addEventListener(ev, onSettingsChange);
        $perMin.addEventListener(ev, onSettingsChange);
      });
      $autoExport.addEventListener("change", onSettingsChange);

      document.getElementById("addBtn").addEventListener("click", () => {
        const n = ($input.value || "").trim();
        if(!n) return;
        students.push({ id: uid(), name: n, carry: false, spoke: 0, missed: 0, absences: 0 });
        save(students);
        render(students);
        $input.value = "";
        $input.focus();
      });
      document.getElementById("input").addEventListener("keydown", (e) => { if(e.key === "Enter") { e.preventDefault(); document.getElementById("addBtn").click(); } });

      // ===== Init =====
      function updateStaticTexts(){
        document.title = t("app_title");
        const ttl = t("app_title");
        const parts = ttl.split(" ");
        if (parts.length >= 2) {
          const a = parts[0], b = parts.slice(1).join(" ");
          $hdrTitle.innerHTML = `<span class="hl">${a.slice(0,3)}</span>${a.slice(3)} <span class="hl">${b.slice(0,3)}</span>${b.slice(3)}`;
        } else {
          $hdrTitle.textContent = ttl;
        }

        $importBtn.textContent = t("import");
        $exportBtn.textContent = t("export");
        $helpBtn.textContent = t("help");
        $importBtn.title = t("import"); $exportBtn.title = t("export"); $helpBtn.title = t("help");

        $randomize.textContent = t("randomize");
        $shareBtn.textContent = t("share");
        $endBtn.textContent = t("end");
        $clearQueue.textContent = t("clear_queue");
        $resetStats.textContent = t("reset_stats");

        $timeSettingsTitle.textContent = t("time_settings");
        ($lblPair.querySelector("span")||$lblPair).textContent = t("pair_label")+" ";
        ($lblPer.querySelector("span")||$lblPer).textContent = t("per_label")+" ";
        $calcNote.textContent = t("calc_note");
        $lblAutoExport.textContent = t("auto_export");

        $studentsTitle.textContent = t("students");
        $input.placeholder = t("add_placeholder");
        $absModeText.textContent = t("abs_mode");
        $hintStats.innerHTML = t("hint_stats");
        $emptyList.textContent = t("empty_list");
        $add.title = t("add");
        $add.setAttribute("aria-label", t("add"));

        $queueTitle.textContent = t("queue_today");
        $emptyQueue.textContent = t("empty_queue");
        document.getElementById("hintQueueAbs").textContent = t("hint_queue_abs");

        renderHelpTexts();
        updateCaps();
        render(students);
        renderQueue();
      }

      if (!localStorage.getItem(LANG_KEY)) setLang(document.documentElement.lang || "ru");
      else document.documentElement.lang = getLang();
      $langSel.value = getLang();
      $langSel.title = t("lang_title");
      $langSel.addEventListener("change", () => {
        setLang($langSel.value);
        updateStaticTexts();
      });

      // Apply pending finalize only when it was a true exit
      applyPendingIfNeeded();

      const settings = loadS();
      $pairMin.value = settings.pair;
      $perMin.value = settings.per;
      $autoExport.checked = !!settings.autoExport;

      render(students);
      if (queue.length && absentToday.size) {
        queue = queue.filter(id => !absentToday.has(id));
        saveQ(queue);
      }
      renderQueue();
      updateCaps();
      updateBadges();
      renderHelpTexts();
      updateStaticTexts();
      // enforce Sem/Ran subtle highlight
      (function(){
        const ttl = t("app_title");
        const parts = ttl.split(" ");
        if (parts.length >= 2) {
          const a = parts[0], b = parts.slice(1).join(" ");
          $hdrTitle.innerHTML = `<span class="hl">${a.slice(0,3)}</span>${a.slice(3)} <span class="hl">${b.slice(0,3)}</span>${b.slice(3)}`;
        }
      })();

    })();
  </script>
</body>
</html>
